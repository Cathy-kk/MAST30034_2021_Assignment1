---
title: "ADS_Assignment"
author: "Kaixin Yu"
student ID: 1118795
output:
  html_document: default
  word_document: default
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#install.packages("corrplot")
install.packages("factoextra")
nolibrary('plot.matrix')
library(corrplot)
library(reshape2)
library(ggplot2)
library(matrixStats)
library("factoextra")
```

 
Question 1
Q1.1
```{r}
# create TC sources
par(mfrow=c(2,3))
TC_1<- c(rep(rep(c(1,0), each =15), 8))
TC_2<- c(rep(0,20), rep(rep(c(1,0),c(20,25)), length.out=220))
TC_3 <- c(rep(rep(c(1,0), c(25, 60-25)), length.out=240))
TC_4 <- c(rep(rep(c(1,0), c(15, 40-15)), length.out=240))
TC_5 <- c(rep(rep(c(1,0), c(20, 40-20)), length.out=240))
TC_6 <- c(rep(rep(c(1,0), c(25, 40-25)), length.out=240))
TC <- matrix(c(TC_1, TC_2, TC_3, TC_4, TC_5, TC_6), 240,6)
TC <- scale(TC)
TC_title<- c("TC_1", "TC_2", "TC_3", "TC_4", "TC_5", "TC_6")
# plot TC sources
for (i in (1:6)){
  plot(TC[,i], type='l', xlab="", ylab="", main=TC_title[i])
}

```

```{r}
# normalize TC with L-2 norm
par(mfrow=c(2,3))
TC_normal <- matrix(c(TC_1, TC_2, TC_3, TC_4, TC_5, TC_6), 240,6)
for (i in (1:6)){
  TC_normal[,i] <- TC_normal[,i]/sqrt(sum(TC_normal[,i]**2))
  plot(TC_normal[,i], type='l', xlab="", ylab="", main=TC_title[i])

}
```

Q 1.2
```{r}
# plot correaltion matrix of TC 
par(mfrow = c(1,1))
par(mar=c(5.1, 4.1, 4.1, 4.1))
plot(cor(TC), main="Correlation of time sources")
```

Q 1.3
```{r}
# create 6 SMs and plot them out
par(mfrow=c(2,3))
tmpSM_1<- matrix(rep(0, 441), 21,21)
tmpSM_1[c(2:6), c(2:6)] <- 1
plot(tmpSM_1, border=NA)

tmpSM_2<- matrix(rep(0, 441), 21,21)
tmpSM_2[c(2:6), c(15:19)] <- 1
plot(tmpSM_2, border=NA)

tmpSM_3<- matrix(rep(0, 441), 21,21)
tmpSM_3[c(8:13), c(2:6)] <- 1
plot(tmpSM_3, border=NA)

tmpSM_4<- matrix(rep(0, 441), 21,21)
tmpSM_4[c(8:13), c(15:19)] <- 1
plot(tmpSM_4, border=NA)

tmpSM_5<- matrix(rep(0, 441), 21,21)
tmpSM_5[c(15:19), c(2:6)] <- 1
plot(tmpSM_5, border=NA)

tmpSM_6<- matrix(rep(0, 441), 21,21)
tmpSM_6[c(15:19), c(15:19)] <- 1
plot(tmpSM_6, border=NA)
```

```{r}
# plot the correlation matrix of SM
par(mfrow = c(1,1))
par(mar=c(3.1, 4.1, 4.1, 4.1))

tmpSM <- matrix(c(as.vector(tmpSM_1), as.vector(tmpSM_2), as.vector(tmpSM_3), as.vector(tmpSM_4), as.vector(tmpSM_5), as.vector(tmpSM_6)), 6, 441, byrow = TRUE)

corrplot(cor(t(tmpSM)),title = "Correlation Matrix of tmpSM", addCoef.col="black", method="color")
```

Q 1.4
```{r}
# create noise and plot correlation matrix for TC 
set.seed(123)
par(mfrow=c(1,2))
TC_noise <- matrix(rnorm(240*6, mean=0, sd=sqrt(0.25)), 240,6)
TC_noise_cor <- cor(TC_noise)
corrplot(TC_noise_cor, method='color', addCoef.col="black", title="CM for TC noise", mar=c(0,0,1,0))

# create noise and plot correlation matrix for SM
tmpSM_noise <- matrix(rnorm(6*441, mean=0, sd=sqrt(0.015)), 6, 441)
tmpSM_noise_cor <- cor(t(tmpSM_noise))
corrplot(tmpSM_noise_cor, method='color', addCoef.col="black", title="CM for SM noise",mar=c(0,0,1,0))
```

as the plots shown, the noise of both two sources are independent.

```{r}
# plot the histogram for both noise source and add distribution curve
hist(as.vector(TC_noise), prob=TRUE)
curve(dnorm(x, mean=0, sd = sqrt(1.96*0.25)), col="red", lwd=2, add=TRUE)

hist(as.vector(t(tmpSM_noise)), prob=TRUE)
curve(dnorm(x, mean=0, sd = sqrt(1.96*0.015)), col="red", lwd=2, add=TRUE)
```

Both TC and tmpSM noise look have a normal distributuion, and satisfied the 1.96$\sigma$.

```{r}
# visualize the correlation between the noise product and observed variables
par(mfrow = c(1,1))
par(mar=c(5.1, 4.1, 4.1, 4.1))
noise_product <- TC_noise%*%tmpSM_noise
corrplot(cor(noise_product), method="color")
```

The correlation heap map show non correlation

Q1.5
```{r}
X <- (TC+TC_noise)%*%(tmpSM+tmpSM_noise)

# check the cross product
(dim(TC))
(dim(tmpSM_noise))
(dim(TC_noise))
(dim(tmpSM))
```

The products exists.

```{r}
# get sample
set.seed(123)
par(mfrow = c(1,1))
par(mar=c(5.1, 4.1, 4.1, 4.1))
sample<-data.frame(n=1:240, X[, sample(ncol(X), size=100)])

# plot the sample
sample_gg <- melt(sample, id.vars="n")
ggplot(sample_gg, aes(x=n, y=value, col=variable))+ geom_line()
```

```{r}
# calculate variance of all variables
plot(colVars(X), xlab="variable", ylab="variance", main="Variance of all variables")
X<- scale(X)
```

Q2

Q2.1
```{r}
D <- TC
# retrieve A by LSR
A_lsr <- solve(t(D)%*%D)%*%t(D)%*%X
# retrieve D by LSR
D_lsr <- X%*%t(A_lsr)
```

```{r}
# plot retrieval sources
par(mfrow=c(1,2))
par(mar=c(5.1, 4.1, 4.1, 4.1))
plot(matrix(abs(A_lsr[1,]), 21,21),border=NA,xlab="", ylab="",  main="A_lsr_1")
plot(D_lsr[,1], type='l', xlab="", ylab="", main="D_lsr1")

plot(matrix(abs(A_lsr[2,]), 21,21), border=NA, xlab="", ylab="",
     main="A_lsr_2")
plot(D_lsr[,2], type='l', xlab="", ylab="", main="D_lsr2")

plot(matrix(abs(A_lsr[3,]), 21,21), border=NA,xlab="", ylab="",
     main="A_lsr_3")
plot(D_lsr[,3], type='l', xlab="", ylab="", main="D_lsr3")

plot(matrix(abs(A_lsr[4,]), 21,21), border=NA,xlab="", ylab="",
     main="A_lsr_4")
plot(D_lsr[,4], type='l', xlab="", ylab="", main="D_lsr4")

plot(matrix(abs(A_lsr[5,]), 21,21), border=NA,xlab="", ylab="",
     main="A_lsr_5")
plot(D_lsr[,5], type='l', xlab="", ylab="", main="D_lsr5")

plot(matrix(abs(A_lsr[6,]), 21,21), border=NA,xlab="", ylab="",
     main="A_lsr_6")
plot(D_lsr[,6], type='l', xlab="", ylab="", main="D_lsr6")
```

```{r}
# scatter plot bewtween 3rd column of D_lsr and 30th column of X
par(mfrow = c(1,1))
par(mar=c(5.1, 4.1, 4.1, 4.1))
plot(D_lsr[,3], X[,30], xlab="3rd column of D_lsr", ylab="30th column of X")

# check which spatial signal stay at 1
(temSM[,30])
```

since only the third regressor is actived, which means the TC_3 makes contributions to 30th columns of X

Q2.2
```{r}
# select $\lambda\$ by using check and guess method
D <- TC
# retrieve A by LSR

#randomly generate lamda
set.seed(30034)
(lambda <- runif(1,0,1))
A_rr <- solve(t(D)%*%D + lambda*441*diag(6))%*%t(D)%*%X
# retrieve D by LSR
D_rr <- X%*%t(A_rr)
```

```{r}
# calculate 
cor_tlse <- cor(D_lsr, TC)
max_cor <- max.col(abs(cor_tlse))
Ctlsr <- rep(NA, 6)
for (i in (1:6)){
  Ctlsr[i] <- abs(cor_tlse)[max_cor[i], i]
}

Ctlsr
```
```{r}
cor_trr <- cor(D_rr, TC)
max_cor <- max.col(abs(cor_trr))
Ctrr <- rep(NA, 6)
for (i in (1:6)){
  Ctrr[i] <- abs(cor_trr)[max_cor[i], i]
}

Ctrr
```

```{r}
(sum(Ctlsr))
(sum(Ctrr))
```

```{r}
A_rr_1000 <- solve(t(D)%*%D + 1000*441*diag(6))%*%t(D)%*%X
plot(A_rr_1000[1,], type='l')
plot(A_lsr[1,], type='l')
```

Q2.3
```{r}
# remove set seed
rm(.Random.seed, envir=globalenv())

# code for perform LR
MSE_lr <- array(NA, c(10, 21))
rho <- seq(0,1,0.05)
for (realization in 1:10){
  if (realization==1) X_lr <-X
  else {
    TC_noise_lr <- matrix(rnorm(240*6, mean=0, sd=sqrt(0.25)), 240,6)
    SM_noise_lr <- matrix(rnorm(6*441, mean=0, sd=sqrt(0.015)), 6,441)
    X_lr <- (TC + TC_noise_lr)%*%(tmpSM + SM_noise_lr)
    X_lr <- scale(X_lr)
  }
for(rr in 1:21){
  
  step <- 1/(norm(TC %*% t(TC)) * 1.1)
  thr <- rho[rr]*240*step
  nsrcs <- 6
  Ao <- matrix(0, nsrcs, 1)
  A <- matrix(0, nsrcs, 1)
  Alr <- matrix(0, nsrcs, 21*21)

  for (k in 1:(21*21)) {
    A <- Ao+step*(t(TC) %*% (X_lr[,k]-(TC%*%Ao)))
    A <- (1/(1+thr)) * (sign(A)*pmax(replicate(nsrcs, 0), abs(A)-thr))
  
    for (i in 1:10) {
      Ao <- A
      A <- Ao+step * (t(TC)%*%(X_lr[,k]-(TC%*%Ao)))
      A <- (1/(1+thr)) * (sign(A)*pmax(replicate(nsrcs, 0), abs(A)-thr))
    }
    Alr[,k] <- A
  }
  # calculate MSE 
  Dlr <- X_lr%*%t(Alr)
  MSE <- sum((X_lr-Dlr%*%Alr)**2)/(240*441)
  MSE_lr[realization, rr] <- MSE
}
}
```

```{r}
avg_MSE_lr <- colMeans(MSE_lr)
plot(rho, avg_MSE_lr)
```

```{r}
(avg_MSE_lr)
(index <- which.min(avg_MSE_lr))
(min_MSE<- avg_MSE_lr[index])
(rho_lr <- rho[index])
```

At the minimum MSE, \rho = 0.6, the value of average MSE is 0.4599621

Q2.4
```{r}
# use rho_lr = 0.7, estimate A_lr parameter
step <- 1/(norm(TC %*% t(TC)) * 1.1)
thr <- rho_lr*240*step
Ao <- matrix(0, nsrcs, 1)
A <- matrix(0, nsrcs, 1)
A_lr <- matrix(0, nsrcs, 21*21)

for (k in 1:(21*21)) {
  A <- Ao+step*(t(TC) %*% (X[,k]-(TC%*%Ao)))
  A <- (1/(1+thr)) * (sign(A)*pmax(replicate(nsrcs, 0), abs(A)-thr))
  
  for (i in 1:10) {
    Ao <- A
    A <- Ao+step * (t(TC)%*%(X[,k]-(TC%*%Ao)))
    A <- (1/(1+thr)) * (sign(A)*pmax(replicate(nsrcs, 0), abs(A)-thr))
  }
  A_lr[,k] <- A
}

# use A_lr to estimate D_lr
D_lr <- X%*%t(A_lr)
```

```{r}
# get Csrr
cor_srr <- cor(t(A_rr), t(tmpSM))
max_cor <- max.col(abs(cor_srr))
Csrr <- rep(NA, 6)
for (i in (1:6)){
  Csrr[i] <- abs(cor_srr)[max_cor[i], i]
}

Csrr
```

```{r}
#get Ctlr
cor_tlr <- cor(D_lr, TC)
max_cor <- max.col(abs(cor_tlr))
Ctlr <- rep(NA, 6)
for (i in (1:6)){
  Ctlr[i] <- abs(cor_tlr)[max_cor[i], i]
}

Ctlr
```

```{r}
# get Cslr
cor_slr <- cor(t(A_lr), t(tmpSM))
max_cor <- max.col(abs(cor_slr))
Cslr <- rep(NA, 6)
for (i in (1:6)){
  Cslr[i] <- abs(cor_slr)[max_cor[i], i]
}

Cslr
```


```{r}
# sum of four correlation vector
(sum_Ctrr<-sum(Ctrr))
(sum_Csrr<-sum(Csrr))
(sum_Ctlr<-sum(Ctlr))
(sum_Cslr<-sum(Cslr))
```

sum of Ctlr and Cslr are both larger than Ctrr and Csrr

```{r}
# plot D_rr, A_rr, D_lr, A_lr
par(mfrow=c(6,4))
par(mar=c(1,1,1,1))
plot(matrix(abs(A_rr[1,]), 21,21), border=NA,xlab="", ylab="",key=NULL,
     main="A_Ridge")

plot(D_rr[,1], type='l', xlab="", ylab="", main="D_Ridge")

plot(matrix(abs(A_lr[1,]), 21,21), border=NA,xlab="", ylab="",key=NULL,
     main="A_Lasso")
plot(D_lr[,1], type='l', xlab="", ylab="", main="D_Lasso")

for (i in 2:6){
  plot(matrix(abs(A_rr[i,]), 21,21), border=NA,xlab="", ylab="", main="",key=NULL)
  plot(D_rr[,i], type='l', xlab="", ylab="",main="")

  plot(matrix(abs(A_lr[i,]), 21,21), border=NA,xlab="", ylab="",main="",key=NULL)
  plot(D_lr[,i], type='l', xlab="", ylab="",main="")
}

```


Q2.5
```{r}
# build PCA
PC <- prcomp(D, center = TRUE, scale.=TRUE)
eig.val <- get_eigenvalue(PC)
(eig.val$eigenvalue)
fviz_eig(PC, geom="line", choice = "eigenvalue", addlabels = TRUE)+ labs(title = "Eigenvalue-PCA", x = "Principal Components", y = "Eigenvalue")
(eig_pc <- PC$sdev^2)
```

The 6th PC owns the minimum eigenvalue, 0.2. 

```{r}
par(mfrow=c(1,2))
par(mar=c(5.1, 2, 4.1, 2))
Z_pc <- PC$x
Z_title<- c("Z_PC_1", "Z_PC_2", "Z_PC_3", "Z_PC_4", "Z_PC_5", "Z_PC_6")
for (i in 1:6){
  plot(Z_pc[,i], type='l', xlab="", ylab="", main=Z_title[i])
  plot(TC[,i], type='l', xlab="", ylab="",main=TC_title[i])
}
```

```{r}
# perform lasso with Z on X
step <- 1/(norm(Z_pc %*% t(Z_pc)) * 1.1)
rho_pcr <- 0.001
thr <- rho_pcr*240*step
Ao <- matrix(0, nsrcs, 1)
A <- matrix(0, nsrcs, 1)
A_pcr <- matrix(0, nsrcs, 21*21)

for (k in 1:(21*21)) {
  A <- Ao+step*(t(Z_pc) %*% (X[,k]-(Z_pc%*%Ao)))
  A <- (1/(1+thr)) * (sign(A)*pmax(replicate(nsrcs, 0), abs(A)-thr))
  
  for (i in 1:10) {
    Ao <- A
    A <- Ao+step * (t(Z_pc)%*%(X[,k]-(Z_pc%*%Ao)))
    A <- (1/(1+thr)) * (sign(A)*pmax(replicate(nsrcs, 0), abs(A)-thr))
  }
  A_pcr[,k] <- A
}

# use A_lr to estimate D_lr
D_pcr <- X%*%t(A_pcr)
```

```{r}
par(mfrow=c(1,2))
par(mar=c(5.1, 3.1, 4.1, 4.1))
Apcr_title<- c("A_PCR_1", "A_PCR_2", "A_PCR_3", "A_PCR_4", "A_PCR_5", "A_PCR_6")
Dpcr_title<- c("D_PCR_1", "D_PCR_2", "D_PCR_3", "D_PCR_4", "D_PCR_5", "D_PCR_6")
for (i in 1:6){
  plot(matrix(abs(A_pcr[i,]), 21,21), border=NA,xlab="", ylab="", main=Apcr_title[i])
  plot(D_pcr[,i], type='l', xlab="", ylab="",main=Dpcr_title[i])
}
```

```{r}
par(mfrow=c(6,4))
par(mar=c(1,1,1,1))

#plot all four model retrived A
plot(matrix(abs(A_lsr[1,]), 21,21), border=NA,xlab="", ylab="",key=NULL,
     main="A_LSR")

plot(matrix(abs(A_rr[1,]), 21,21), border=NA,xlab="", ylab="",key=NULL,
     main="A_Ridge")

plot(matrix(abs(A_lr[1,]), 21,21), border=NA,xlab="", ylab="",key=NULL,
     main="A_Lasso")

plot(matrix(abs(A_pcr[1,]), 21,21), border=NA,xlab="", ylab="",key=NULL,
     main="A_PCA")

for (i in 2:6){
  plot(matrix(abs(A_lsr[i,]), 21,21), border=NA,xlab="", ylab="",key=NULL,
     main="")

plot(matrix(abs(A_rr[i,]), 21,21), border=NA,xlab="", ylab="",key=NULL,
     main="")

plot(matrix(abs(A_lr[i,]), 21,21), border=NA,xlab="", ylab="",key=NULL,
     main="")

plot(matrix(abs(A_pcr[i,]), 21,21), border=NA,xlab="", ylab="",key=NULL,
     main="")
}
```

```{r}
par(mfrow=c(6,4))
par(mar=c(1,1,1,1))

#plot all four model retrived A
plot(D_lsr[,1], type='l', xlab="", ylab="", main="D_LSR")
plot(D_rr[,1], type='l', xlab="", ylab="", main="D_Ridge")
plot(D_lr[,1], type='l', xlab="", ylab="", main="D_Lasso")
plot(D_pcr[,1], type='l', xlab="", ylab="", main="D_PCR")

for (i in 2:6){
  plot(D_lsr[,i], type='l', xlab="", ylab="", main="")
  plot(D_rr[,i], type='l', xlab="", ylab="", main="")
  plot(D_lr[,i], type='l', xlab="", ylab="", main="")
  plot(D_pcr[,i], type='l', xlab="", ylab="", main="")

}
```

```{r}
```